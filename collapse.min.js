
function CellObject(a,b,c,d,e,f){this.index=a,this.code=b,this.rect=c,this.font=d,this.bgColor=e,this.borderColor=f,this.valid=!0,CellObject.prototype.topCell=function(){var a=this.index-cols;return a>=0?objects[a]:null},CellObject.prototype.rightCell=function(){var a=this.index+1;return map.length>a&&0!=a&&a%cols>0?objects[a]:null},CellObject.prototype.bottomCell=function(){var a=this.index+cols;return map.length-1>a?objects[a]:null},CellObject.prototype.leftCell=function(){var a=this.index-1;return a>=0&&1!=a&&cols-1>a%cols?objects[a]:null},CellObject.prototype.cellsInSameColumn=function(){for(var a=[],b=this.colNr();objects.length>b;b+=cols)a.push(objects[b].index);return a.sort(function(a,b){return a-b})},CellObject.prototype.lastCellInSameColumn=function(){return objects.length-(cols-this.colNr())},CellObject.prototype.cellsInSameRow=function(){for(var a=[],b=this.index-this.colNr(),c=0;cols>c;c++)a.push(objects[b+c].index);return a.sort(function(a,b){return a-b})},CellObject.prototype.rowNr=function(){return Math.floor(this.index/cols)},CellObject.prototype.colNr=function(){return this.index-Math.floor(this.rowNr()*cols)}}function Font(a,b,c,d){Font.BOLD="bold",Font.DEFAULT_SIZE=12,Font.DEFAULT_BOLD="normal",Font.DEFAULT_NAME="Monaco",Font.DEFAULT_COLOR="#000000",this.size=a&&a>0?a:Font.DEFAULT_SIZE,this.name=b&&b.length>0?b:Font.DEFAULT_NAME,this.weight=c&&c.length>0?c:Font.DEFAULT_BOLD,this.color=d&&d.length>0?d:Font.DEFAULT_COLOR,Font.prototype.toString=function(){return"size="+this.size+", "+"name="+this.name+", "+"weight="+this.weight+", "+"color="+this.color}}function Rectangle(a,b,c,d){this.x=a,this.y=b,this.width=c,this.height=d,this.left=a,this.top=b,this.right=a+c+1,this.bottom=b+d+1,Rectangle.prototype.toString=function(){return"x="+this.x+", "+"y="+this.y+", "+"w="+this.width+", "+"h="+this.left}}function Score(a,b){this.level=a,this.score=b}function generateMap(a){map=[];for(var b=0;mapSize>b;b++)map[b]=Math.floor(Math.random()*a);rows=Math.floor(Math.sqrt(map.length)),cols=Math.floor(map.length/rows)}function isCanvasSupported(){var a=document.createElement("canvas");return!(!a.getContext||!a.getContext("2d"))}function newGame(){isCanvasSupported()||$("#"+gameContainer).html(TXT_NO_HTML5_CONTEXT),arguments.length>0&&(currentGame=arguments[0]),generateMap(currentGame),loadScoreTable(),scoreNrEl=$("#"+scoreNrElementId),resetScore();var b=canvasPadding,d=canvasPadding;for(canvasWidth=(cellW+cellMargin)*cols+2*canvasPadding,canvasHeight=(cellH+cellMargin)*rows+2*canvasPadding,canvasObj=$("<canvas/>",{id:canvasId}).width(canvasWidth).height(canvasHeight),canvas=canvasObj[0],ctx=canvas.getContext("2d"),canvas.width=canvasWidth,canvas.height=canvasHeight,$("#"+canvasContainer).html(canvasObj),$("#"+canvasContainer).width(canvasWidth),$("#"+canvasContainer).height(canvasHeight),drawRect(ctx,canvasBorderColor,canvasBackgroundColor,new Rectangle(0,0,canvasObj.width(),canvasObj.height())),c=0;map.length>c;c++){var f=new Rectangle(b,d,cellW,cellH),g=map[c];objects[c]=new CellObject(c,g,f,cellFont,colorsHex[g],colorsHexBorder[g]),objects[c],b+=cellW+cellMargin,c%cols==cols-1&&(b=canvasPadding,d+=cellH+cellMargin)}drawCells(),document.getElementById(canvasId).onmousedown=function(a){a.preventDefault(),canvasMouseDown(a)},document.getElementById(canvasId).onmouseup=function(a){canvasMouseUp(a),anyMovesLeft()||(isBoardClear()&&updateScore(objects[0].cellsInSameRow()),showCredits())}}function loadImages(){for(var b=0;colorsImg.length>b;b++)if(!(colorsImg[b]instanceof Image)){var c=new Image;c.src=colorsImg[b],colorsImg[b]=c}}function isBoardClear(){for(var a=0;objects.length>a;a++)if(objects[a].valid)return!1;return!0}function showCredits(){drawRect(ctx,canvasBorderColor,"rgba(255, 255, 255, 0.5)",new Rectangle(0,0,canvasObj.width(),canvasObj.height()));var a=new Font(24,"",Font.BOLD,"#000000"),b=TXT_FINAL_SCORE_PRE_TEXT+currScore+TXT_FINAL_SCORE_POST_TEXT;drawTextCentered(ctx,b,new Rectangle(0,0,canvasObj.width(),canvasObj.height()),a),document.getElementById(canvasId).onmousedown=function(){},document.getElementById(canvasId).onmouseup=function(){},updateScoreTable()}function loadScoreTable(){if(null==gamesScoreTable||1>gamesScoreTable.length){var a=readCookie(gamesScoreCookieName);gamesScoreTable=$.parseJSON(a),null==gamesScoreTable&&(gamesScoreTable=[]),console.log(a),console.log(gamesScoreTable.length),updateScoreTable()}}function clearScoreTable(){gamesScoreTable=[],eraseCookie(gamesScoreCookieName),console.log(readCookie(gamesScoreCookieName)),console.log(gamesScoreTable),$("#"+scoreTableContainer).html("<h3>Skortafla</h3><ul></ul>")}function updateScoreTable(){if(currScore>0){gamesScoreTable.push(new Score(currentGame,currScore)),gamesScoreTable=gamesScoreTable.sort(function(a,b){return b.score-a.score});for(var b=[],c=0;gamesScoreTable.length>c&&entriesInScoreTable>c;c++)b[c]=gamesScoreTable[c];createCookie(gamesScoreCookieName,JSON.stringify(b),gamesScoreCookieExipresInDays)}for(var d="",c=0;gamesScoreTable.length>c&&entriesInScoreTable>c;c++){var e=gamesScoreTable[c],f=c+1+". "+gameLevelLabels[e.level]+" - "+e.score;e.score==currScore&&(f="<b>"+f+"</b>"),d+="<li>"+f+"</li>"}f="<h3>Skortafla</h3><ul>"+d+"</ul>",gamesScoreTable.length>0&&(f+='<i><a href="javascript:clearScoreTable();">Tæma skortöflu</a></i>'),$("#"+scoreTableContainer).html(f)}function createCookie(a,b,c){if(c){var d=new Date;d.setTime(d.getTime()+1e3*60*60*24*c);var e="; expires="+d.toGMTString()}else var e="";document.cookie=escape(a)+"="+escape(b)+e+"; path=/"}function readCookie(a){for(var b=escape(a)+"=",c=document.cookie.split(";"),d=0;c.length>d;d++){for(var e=c[d];" "==e.charAt(0);)e=e.substring(1,e.length);if(0==e.indexOf(b))return unescape(e.substring(b.length,e.length))}return null}function eraseCookie(a){createCookie(a,"",-1)}function updateScore(a){if(!(minCellsToScore>a.length)){var b=scorePerBrickInMove*a.length;b+=b*scoreBonusPerBrickInMove*a.length,currScore+=Math.floor(b),scoreNrEl.html(TXT_SCORE_PRE_TEXT+currScore+TXT_SCORE_POST_TEXT)}}function resetScore(){currScore=0,scoreNrEl.html(TXT_SCORE_PRE_TEXT+currScore+TXT_SCORE_POST_TEXT)}function anyMovesLeft(){for(var a=0;objects.length>a;a++)if(flood(a).length>1)return!0;return!1}function getCellText(a){return DEBUG?a.rowNr()+"x"+a.colNr()+" "+a.index:""}function drawCells(){for(c=0;objects.length>c;c++){var a=objects[c];a.valid?(USE_IMG?drawImg(ctx,colorsImg[a.code],a.rect):drawRect(ctx,a.borderColor,a.bgColor,a.rect),drawTextCentered(ctx,getCellText(a),a.rect,a.font)):(drawRect(ctx,canvasBackgroundColor,canvasBackgroundColor,a.rect),drawTextCentered(ctx,getCellText(a),a.rect,a.font))}}function flood(a){var b=objects[a];if(!b.valid)return[];for(var c=b.code,d=[],e=[b];e.length>0;)if(b=e.pop(),0>valueInArray(b.index,d)){d.push(b.index);for(var f=[b.topCell(),b.rightCell(),b.bottomCell(),b.leftCell()],g=0;f.length>g;g++){var h=f[g];null!=h&&h.valid&&h.code==c&&0>valueInArray(h.index,d)&&e.push(h)}}return d}function empty(a){for(var b=0;a.length>b;b++){var c=a[b];objects[c],objects[c].valid=!1}}function collapse(a){for(var b=[],c=0;a.length>c;c++){var d=objects[a[c]],e=d.colNr();if(!(valueInArray(e,b)>=0)){b.push(e);for(var f=d.cellsInSameColumn().sort(function(a,b){return b-a}),h=0;f.length>h;h++){var i=objects[f[h]];if(!i.valid)for(var j=i.topCell();null!=j;){if(j.valid){switchCells(j,i);break}j=j.topCell()}}}}}function allCellsInvalid(a){for(var b=0;a.length>b;b++){var c=a[b];if(objects[c].valid)return!1}return!0}function switchColumns(a,b){if(a.length==b.length)for(var c=0;a.length>c;c++){var d=objects[a[c]],e=objects[b[c]];switchCells(d,e)}}function switchCells(a,b){var c=a.rect;a.rect=b.rect,b.rect=c;var d=a.index;a.index=b.index,b.index=d,objects[a.index]=a,objects[b.index]=b}function resetLastActive(){if(lastCellActive>=0){var a=objects[lastCellActive];if(a.valid){var b=objects[lastCellActive];value=lastCellActive+"::"+b,USE_IMG?drawImg(ctx,colorsImg[a.code],a.rect):drawRect(ctx,a.borderColor,a.bgColor,a.rect),drawTextCentered(ctx,getCellText(a),a.rect,cellFont)}}lastCellActive=-1}function canvasMouseUp(a){var b=mouseOverCellIdx(a);if(b==lastCellActive&&lastCellActive>=0){var c=flood(lastCellActive);if(c.length>1){empty(c),collapse(c);for(var d=objects[0].cellsInSameRow(),e=0;d.length>e;e++){var b=d[e],f=objects[b].cellsInSameColumn();if(allCellsInvalid(f))for(var g=e+1;d.length>g;g++){var h=d[g],i=objects[h].cellsInSameColumn();if(!allCellsInvalid(i)){switchColumns(f,i);break}}}updateScore(c)}drawCells()}resetLastActive(),lastCellActive=-1}function drawImg(a,b,c){ctx.drawImage(b,c.x,c.y,c.width,c.height)}function drawRect(a,b,c,d){a.strokeStyle=b,a.fillStyle=c,a.fillRect(d.x,d.y,d.width,d.height),a.strokeRect(d.x+1,d.y+1,d.width-2,d.height-2),a.stroke()}function drawTextCentered(a,b,c,d){var e=d.weight==Font.BOLD?Font.BOLD+" ":"";e+=d.size?d.size+"px ":"",e+=d.name?d.name:"",a.fillStyle=d.color,a.font=e;var f=a.measureText(b),g=c.x+c.width/2-f.width/2,h=c.y+c.height/2+d.size/3;a.fillText(b,g,h)}function valueInArray(a,b){for(var c=0;b.length>c;c++)if(a==b[c])return c;return-1}function canvasMouseDown(a){a.preventDefault(),resetLastActive();var b=mouseOverCellIdx(a);if(!(0>b)){var c=objects[b];c.valid&&(b+"::"+objects[b].code,USE_IMG||drawRect(ctx,colorsHexBorderActive[c.code],colorsHexActive[c.code],c.rect),drawTextCentered(ctx,getCellText(c),c.rect,cellFontActive),lastCellActive=b)}}function mouseOverCellIdx(a){var b=document.all?!0:!1;a=a||window.event;var c=canvasObj.position().left,d=canvasObj.position().top;b?(c=a.clientX+document.body.scrollLeft-c,d=a.clientY+document.body.scrollTop-d):(c=a.pageX-c,d=a.pageY-d);var e=0;for(e=0;objects.length>e;e++){var f=objects[e],g=f.rect;if(c>g.left&&g.right>c&&d>g.top&&g.bottom>d)return e}return-1}new Font(1,null,null,null);var TXT_NO_HTML5_CONTEXT="Vafrinn þinn styður ekki html5 þannig að þú getur ekki spilað... sorrí.",TXT_FINAL_SCORE_PRE_TEXT="Þú skoraðir ",TXT_FINAL_SCORE_POST_TEXT=" stig!",TXT_SCORE_PRE_TEXT="Þú ert með ",TXT_SCORE_POST_TEXT=" stig!",currScore=0,minCellsToScore=2,scoreNrElementId="scoreNr",scoreNrEl=null,scorePerBrickInMove=10,scoreBonusPerBrickInMove=.1,easyGame=3,mediumGame=4,hardGame=5,gameLevelLabels={3:"Auðveldur",4:"Miðlungs erfiður",5:"Mjög erfiður"},currentGame=mediumGame,DEBUG=!1,USE_IMG=!0,colorsHex=["#483d8b","#006400","#ffa500","#972222","#8b7765"],colorsImg=["img/brick_blue.png","img/brick_green.png","img/brick_yellow.png","img/brick_red.png","img/brick_gray.png"],colorsHexActive=["#6859CC","#009700","#FFC200","#C62222","#AF9280"],colorsHexBorder=["#6859CC","#009700","#FFC200","#C62222","#AF9280"],colorsHexBorderActive=["#6859CC","#009700","#FFC200","#C62222","#AF9280"],canvasObj=null,objects=[],rows=15,cols=15,mapSize=rows*cols,map=[],cellW=24,cellH=24,cellMargin=0,canvasPadding=2,cellFont=new Font(12,"","normal","#000000"),cellFontActive=new Font(12,"","normal","#000000"),canvasBackgroundColor="#353535",canvasBorderColor="#AAAAAA",cellBackgroundColor="#173569",cellBorderColor="#000000",cellBackgroundColorActive="#294066",cellBorderColorActive="#637EAD",canvasContainer="canvasContainer",canvasId="gameBoard",lastCellActive=-1,gameContainer="collapseGame",scoreTableContainer="scoreTable",gamesScoreTable=[],gamesScoreCookieName="collapseScore",gamesScoreCookieExipresInDays=3650,entriesInScoreTable=10,canvas=null,ctx=null,canvasWidth=null,canvasHeight=null;USE_IMG&&loadImages();
